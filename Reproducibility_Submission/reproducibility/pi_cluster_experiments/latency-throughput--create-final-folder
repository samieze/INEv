#!/bin/bash
SCRIPT_DIR="$(realpath "$(dirname "$0")")"

RESULTS_FOLDER="$SCRIPT_DIR/results-lt"
PRUNED_FOLDER="$SCRIPT_DIR/results-lt-final" #name of final output folder

rm -rf "$PRUNED_FOLDER"
#rsync -a --delete "$RESULTS_FOLDER/" "$PRUNED_FOLDER"
cp -al "$RESULTS_FOLDER" "$PRUNED_FOLDER"
RESULTS_FOLDER="$PRUNED_FOLDER"

#purge empty .err files
find "$RESULTS_FOLDER" -iname "*.err" -size 0 -exec rm '{}' \;    

#simplify naming of csv files
find "$RESULTS_FOLDER" -iname "*.csv" -exec rename -d 's/(.*)-([0-9]).csv/$2.csv/' {} \;

#simplify naming of .out files
find "$RESULTS_FOLDER" -iname "*.out" -exec rename -d 's/(.*)\.([0-9]).out/$2.out/' {} \;

#delete results folder entries that are non-terminating or non-maximal and terminating
for experiment_folder in "$RESULTS_FOLDER"/*; do
    prev_wd=$(pwd)
    cd "$experiment_folder" || continue
    for mode in CC MS; do
        prev_factor_dir=""
        for factor_dir in $(compgen -G "$mode""_mul*" | sort); do
            factor_dir=$(realpath "$factor_dir")
            pi0_output_file="$factor_dir/0.out"
            if [[ ! -f $pi0_output_file ]]; then 
                echo "WARNING: No output file for pi0 found in folder $factor_dir";
                #rm -rf "$factor_dir"
            else
                if "$SCRIPT_DIR/has_terminated" "$pi0_output_file"; then    
                    rm -rf "$prev_factor_dir"
                    prev_factor_dir="$factor_dir"
                else
                    rm -rf "$factor_dir"
                fi;
            fi;            
        done;
    done;
    cd "$prev_wd" || exit 1
done;

